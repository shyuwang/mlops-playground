name: CI - Code Quality and Tests

on:
    push:
        branches:
            - main
            - 'feature/**'
    pull_request:
        branches: [main]

jobs:
    code-quality:
        name: Code Quality Checks
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                clean: true

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: '3.11'

            - name: Install linting tools
              run: |
                python -m pip install --upgrade pip
                pip install flake8 black

            - name: Lint with flake8
              run: |
                # Stop the build if there are Python syntax errors or undefined names
                flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
                  
                # Exit-zero treats all errors as warnings
                flake8 src/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

            - name: Check code formatting with black
              run: |
                black --check src/
    test:
        name: Unit Tests
        runs-on: ubuntu-latest
        needs: code-quality

        steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Set up Python
          uses: actions/setup-python@v5
          with:
              python-version: '3.11'
        
        - name: Install dependencies
          run: |
            python -m pip install --upgrade pip
            pip install -r requirements.txt
            pip install pytest pytest-cov
        
        - name: Run unit tests
          run: |
            pytest tests/ -v --cov=src --cov-report=term-missing
    
        - name: Test summary
          if: success()
          run: |
            echo "All tests passed successfully!"